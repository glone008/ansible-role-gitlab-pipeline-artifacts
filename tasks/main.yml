- name: GitLab | Get Job Information
  uri:
    url: "{{ gitlab_url }}/api/v4/projects/{{ gitlab_project | regex_replace('/', '%2F') }}/pipelines/{{ gitlab_pipeline }}/jobs"
    headers:
      PRIVATE-TOKEN: "{{ gitlab_token }}"
  register: gitlab_build

- name: GitLab | Create Temporary Folder For Artifacts
  tempfile:
    state: directory
    suffix: artifacts
  register: gitlab_temp_dir

- name: GitLab | Download Artifacts
  get_url:
    url: "{{ gitlab_url }}/api/v4/projects/{{ gitlab_project | regex_replace('/', '%2F') }}/jobs/artifacts/{{ gitlab_build.json[0].ref }}/download?job=build"
    headers: 'PRIVATE-TOKEN: {{ gitlab_token }}'
    dest: "{{ gitlab_temp_dir.path }}/{{ gitlab_pipeline }}.zip"

- name: GitLab | Extract Artifacts
  unarchive:
    remote_src: yes
    src: "{{ gitlab_temp_dir.path }}/{{ gitlab_pipeline }}.zip"
    dest: "{{ gitlab_unarchive_path }}"

- name: GitLab | Delete Temporary Folder
  file:
    dest: "{{ gitlab_temp_dir.path }}"
    state: absent